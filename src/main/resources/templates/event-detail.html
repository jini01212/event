<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head(${event.title})}"></head>

<body class="d-flex flex-column min-vh-100">
<div th:replace="~{layout :: navbar}"></div>

<div class="container my-5">
    <!-- 뒤로가기 버튼 -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">홈</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${event.title}">이벤트 상세</li>
        </ol>
    </nav>

    <!-- 알림 메시지 -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- 이벤트 이미지 -->
        <div class="col-lg-6 mb-4">
            <div class="position-relative">
                <div th:if="${event.imageUrl}">
                    <img th:src="${event.imageUrl}" class="img-fluid rounded shadow" th:alt="${event.title}">
                </div>
                <div th:unless="${event.imageUrl}"
                     class="bg-light d-flex align-items-center justify-content-center rounded shadow"
                     style="height: 400px;">
                    <i class="fas fa-image fa-5x text-muted"></i>
                </div>

                <!-- 매진 배지 -->
                <span th:if="${event.availableTickets <= 0}"
                      class="position-absolute top-0 end-0 badge bg-danger fs-6 m-3">매진</span>
            </div>
        </div>

        <!-- 이벤트 정보 및 예매 폼 -->
        <div class="col-lg-6">
            <h1 class="display-6 fw-bold mb-4" th:text="${event.title}">이벤트 제목</h1>

            <!-- 이벤트 기본 정보 -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>이벤트 정보</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-3"><i class="fas fa-calendar text-primary me-2"></i><strong>일시</strong></div>
                        <div class="col-sm-9" th:text="${#temporals.format(event.eventDate, 'yyyy년 MM월 dd일 (E) HH:mm')}"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><i class="fas fa-map-marker-alt text-primary me-2"></i><strong>장소</strong></div>
                        <div class="col-sm-9" th:text="${event.location}"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><i class="fas fa-won-sign text-primary me-2"></i><strong>가격</strong></div>
                        <div class="col-sm-9">
                            <span class="h4 text-primary fw-bold" th:text="${#numbers.formatDecimal(event.price, 0, 'COMMA', 0, 'POINT')} + '원'"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3"><i class="fas fa-users text-primary me-2"></i><strong>잔여석</strong></div>
                        <div class="col-sm-9">
                            <span th:text="${event.availableTickets}"></span>/<span th:text="${event.maxTickets}"></span>석
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar"
                                     th:style="'width: ' + ${(event.maxTickets - event.availableTickets) * 100 / event.maxTickets} + '%'"></div>
                            </div>
                            <span th:if="${event.availableTickets <= 0}" class="text-danger mt-1 d-block">
                                <i class="fas fa-exclamation-triangle me-1"></i>매진되었습니다
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 예매 폼 -->
            <div th:if="${event.availableTickets > 0}">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>예매하기</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/event/{id}/book(id=${event.id})}"
                              th:object="${reservation}" method="post">

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">예매자명 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" th:field="*{customerName}"
                                           placeholder="실명을 입력하세요" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">연락처 <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" th:field="*{customerPhone}"
                                           placeholder="010-1234-5678" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">이메일 <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" th:field="*{customerEmail}"
                                       placeholder="example@email.com" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-envelope me-1"></i>티켓 정보가 이메일로 발송됩니다
                                </small>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">티켓 수량</label>
                                    <select class="form-select" th:field="*{ticketCount}" onchange="updateTotal()">
                                        <option th:each="i : ${#numbers.sequence(1, event.availableTickets > 10 ? 10 : event.availableTickets)}"
                                                th:value="${i}" th:text="${i} + '매'"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">결제 방식 <span class="text-danger">*</span></label>
                                    <select class="form-select" th:field="*{paymentMethod}" required>
                                        <option value="">선택하세요</option>
                                        <option value="TOSS">토스페이</option>
                                        <option value="KAKAO">카카오페이</option>
                                        <option value="BANK_TRANSFER">계좌이체</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 총 금액 표시 -->
                            <div class="alert alert-light border">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">총 결제금액</span>
                                    <span class="h5 mb-0 text-primary fw-bold" id="totalAmount"
                                          th:text="${#numbers.formatDecimal(event.price, 0, 'COMMA', 0, 'POINT')} + '원'"></span>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-credit-card me-2"></i>예매하기
                                </button>
                            </div>

                            <small class="text-muted mt-2 d-block text-center">
                                예매 후 취소/변경이 불가하니 신중히 선택해주세요
                            </small>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 매진 메시지 -->
            <div th:unless="${event.availableTickets > 0}" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>매진되었습니다.</strong> 다른 이벤트를 확인해보세요.
                <div class="mt-2">
                    <a href="/" class="btn btn-outline-primary">다른 이벤트 보기</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 이벤트 설명 -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-align-left me-2"></i>이벤트 소개</h5>
                </div>
                <div class="card-body">
                    <div class="fs-6" th:utext="${#strings.replace(event.description, T(java.lang.System).lineSeparator(), '<br>')}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{layout :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const eventPrice = /*[[${event.price}]]*/ 0;

    function updateTotal() {
        const ticketCount = document.querySelector('select[name="ticketCount"]').value;
        const total = eventPrice * parseInt(ticketCount);
        document.getElementById('totalAmount').textContent = total.toLocaleString() + '원';
    }

    // 전화번호 자동 포맷팅
    document.querySelector('input[name="customerPhone"]').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length >= 11) {
            value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        } else if (value.length >= 7) {
            value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1-$2-$3');
        } else if (value.length >= 4) {
            value = value.replace(/(\d{3})(\d+)/, '$1-$2');
        }
        e.target.value = value;
    });
</script>
</body>
</html>