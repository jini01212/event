<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head(${event.id != null ? '이벤트 수정' : '이벤트 등록'})}"></head>

<body class="bg-light">
<!-- Admin Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/admin">
            <i class="fas fa-cogs me-2"></i>EventPlatform Admin
        </a>

        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/admin">
                <i class="fas fa-arrow-left me-1"></i>대시보드
            </a>
            <a class="nav-link" href="/" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i>사용자 페이지
            </a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- 페이지 헤더 -->
            <div class="d-flex align-items-center mb-4">
                <div class="bg-primary text-white rounded-circle me-3 p-2">
                    <i class="fas fa-calendar-plus fa-lg"></i>
                </div>
                <div>
                    <h1 class="h3 mb-1">
                        <span th:if="${event.id == null}">새 이벤트 등록</span>
                        <span th:unless="${event.id == null}">이벤트 수정</span>
                    </h1>
                    <p class="text-muted mb-0">이벤트 정보를 입력하고 저장해주세요</p>
                </div>
            </div>

            <!-- 알림 메시지 -->
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- 이벤트 폼 -->
            <div class="card shadow">
                <div class="card-body p-4">
                    <form th:action="${event.id != null ? '/admin/event/' + event.id + '/edit' : '/admin/event/new'}"
                          th:object="${event}" method="post" enctype="multipart/form-data" id="eventForm">

                        <!-- 기본 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>기본 정보
                                </h5>
                            </div>

                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">이벤트 제목 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" th:field="*{title}"
                                       placeholder="예: 2024 New Year Concert" required maxlength="100">
                                <small class="form-text text-muted">최대 100자까지 입력 가능합니다</small>
                            </div>

                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">이벤트 설명</label>
                                <textarea class="form-control" rows="5" th:field="*{description}"
                                          placeholder="이벤트에 대한 자세한 설명을 입력하세요&#10;&#10;- 이벤트 개요&#10;- 참가 대상&#10;- 주요 프로그램&#10;- 기타 안내사항"></textarea>
                                <small class="form-text text-muted">줄바꿈은 자동으로 적용됩니다</small>
                            </div>
                        </div>

                        <!-- 일시 및 장소 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-calendar-alt me-2 text-primary"></i>일시 및 장소
                                </h5>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">이벤트 일시 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control"
                                       th:field="*{eventDate}" required
                                       th:min="${T(java.time.LocalDateTime).now().toString().substring(0,16)}">
                                <small class="form-text text-muted">현재 시간 이후로만 설정 가능합니다</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">장소 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{location}"
                                       placeholder="예: 강남구 메인홀, 온라인(ZOOM)" required maxlength="100">
                                <small class="form-text text-muted">정확한 장소나 플랫폼명을 입력하세요</small>
                            </div>
                        </div>

                        <!-- 가격 및 수량 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-won-sign me-2 text-primary"></i>가격 및 수량
                                </h5>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">티켓 가격 (원) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" th:field="*{price}"
                                           min="0" step="1000" required placeholder="50000"
                                           oninput="formatPricePreview(this)">
                                    <span class="input-group-text">원</span>
                                </div>
                                <small class="form-text text-muted">1,000원 단위로 입력하세요 (무료: 0원)</small>
                                <div id="pricePreview" class="mt-1 text-primary fw-bold"></div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">최대 티켓 수량 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" th:field="*{maxTickets}"
                                       min="1" max="10000" required placeholder="100">
                                <small class="form-text text-muted">판매할 총 티켓 수량을 입력하세요</small>
                            </div>
                        </div>

                        <!-- 이미지 업로드 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-image me-2 text-primary"></i>이벤트 이미지
                                </h5>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">이벤트 포스터 이미지</label>
                                <input type="file" class="form-control" name="imageFile"
                                       accept="image/*" onchange="previewImage(this)">
                                <small class="form-text text-muted">
                                    권장 크기: 800x600px, 최대 10MB (JPG, PNG, GIF 지원)
                                </small>

                                <!-- 기존 이미지 표시 -->
                                <div th:if="${event.imageUrl}" class="mt-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>현재 등록된 이미지:
                                    </div>
                                    <img th:src="${event.imageUrl}" class="img-thumbnail" style="max-height: 200px;">
                                </div>

                                <!-- 이미지 미리보기 -->
                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <div class="alert alert-success">
                                        <i class="fas fa-eye me-2"></i>새로 선택한 이미지 미리보기:
                                    </div>
                                    <img id="previewImg" class="img-thumbnail" style="max-height: 200px;">
                                </div>
                            </div>
                        </div>

                        <!-- 저장 버튼 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="/admin" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>취소
                                    </a>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" onclick="previewEvent()">
                                            <i class="fas fa-eye me-2"></i>미리보기
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <i class="fas fa-save me-2"></i>
                                            <span th:if="${event.id == null}">등록하기</span>
                                            <span th:unless="${event.id == null}">수정하기</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };

            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }

    function formatPricePreview(input) {
        const value = input.value;
        const preview = document.getElementById('pricePreview');

        if (value && !isNaN(value)) {
            const formatted = parseInt(value).toLocaleString();
            preview.textContent = formatted + '원';
        } else {
            preview.textContent = '';
        }
    }

    function previewEvent() {
        const form = document.getElementById('eventForm');
        const formData = new FormData(form);

        // 간단한 유효성 검사
        if (!formData.get('title') || !formData.get('eventDate') ||
            !formData.get('location') || !formData.get('price') || !formData.get('maxTickets')) {
            alert('필수 항목을 모두 입력해주세요.');
            return;
        }

        alert('미리보기 기능은 개발 중입니다.\n새 탭에서 사용자 페이지를 확인해주세요.');
        window.open('/', '_blank');
    }

    // 폼 제출 시 로딩 표시
    document.getElementById('eventForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>저장중...';
    });

    // 초기 가격 미리보기 설정
    document.addEventListener('DOMContentLoaded', function() {
        const priceInput = document.querySelector('input[name="price"]');
        if (priceInput && priceInput.value) {
            formatPricePreview(priceInput);
        }
    });
</script>
</body>
</html>